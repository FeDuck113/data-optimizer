<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Data optimizer</title>

    <style>
      input {
        width: 50px;
      }

      .hidden {
        display: none;
      }
      .header-row {
        font-weight: bold;
        margin-bottom: 5px;
      }
      .header-row div {
        display: inline-block;
        width: 58px;
      }
    </style>
</head>
<body>
  <!-- Choose mode -->
  <div class="block">
    <h2>Режим работы</h2>
    <label><input type="checkbox" id="calc_coef"> Вычислить коэффициенты</label><br>
    <label><input type="checkbox" id="predict_result" onchange="toggleBlocks()"> Предсказать результат</label>
  </div>

  <!-- Input data -->
  <div class="block">
    <h2>Входные данные</h2>
    <div id="input-header-container" class="row header-row"></div>
    <div id="input-data-container"></div>
    <div>
      <button class="add-button" onclick="addInputRow(true)">+ row</button>
      <button class="remove-button" onclick="removeInputRow()">- row</button>
    </div>
    <input type="file" id="csv-upload" accept=".csv" style="display: none;" onchange="handleCSVUpload(event)">
    <button onclick="document.getElementById('csv-upload').click()">Загрузить CSV</button>
  </div>

  <!-- Сoefficients -->
  <div class="block" id="coefficients-block">
    <h2>Коэффициенты регрессии</h2>
    <div class="row" id="coefficients-row"></div>
  </div>

  <!-- Блок 4: Постоянные -->
  <div class="block">
    <h2>Константы</h2>
    <button onclick="resetConstants()">Сбросить до стандартных значений</button><br>
    <label>G_STANDART: <input type="number" step="0.01" id="g_standart" value="0.33"></label><br>
    <label>F_STANDART: <input type="number" step="0.01" id="f_standart" value="3.63"></label><br>
    <label>T_TEST: <input type="number" step="0.001" id="t_test" value="5.841"></label><br>
    <label>COEF_ACCURACY: <input type="number" id="coef_accuracy" value="6"></label><br>
    <label>RESULT_ACCURACY: <input type="number" id="result_accuracy" value="2"></label><br>
    <label><input type="checkbox" id="optimize_coef" checked> Оптимизировать коэффициенты</label>
  </div>

  <div class="block">
    <button onclick="submitData()">Отправить на сервер</button>
  </div>

<!-- Блок 5: Результат -->
  <div class="block hidden" id="result-block">
    <h2>Результат</h2>
    <p>Здесь будет отображён результат после выполнения предсказания.</p>
  </div>


  <script>
    let inputColumnCount = 4;
    let inputRowCount = 2;

    function createColumnButtons(add, remove) {
      const add_button = document.createElement('button');
      add_button.textContent = "+";
      add_button.onclick = add;
      const delete_button = document.createElement('button');
      delete_button.textContent = "-";
      delete_button.onclick = remove;
      return [add_button, delete_button];
    }

    function updateInputHeaders(columnCount) {
      const headerContainer = document.getElementById('input-header-container');
      headerContainer.innerHTML = '';

      for (let i = 0; i < columnCount-1; i++) {
        const header = document.createElement('div');
        header.textContent = `x${i + 1}`;
        headerContainer.appendChild(header);
      }

      const yHeader = document.createElement('div');
      yHeader.textContent = 'y';
      headerContainer.appendChild(yHeader);
    }

    function addInputRow(last=false) {
      const container = document.getElementById('input-data-container');
      const rows = document.querySelectorAll('#input-data-container .row');
      
      if (rows.length >= 1 & last) {
        const last_row = rows[rows.length - 1];
        last_row.removeChild(last_row.lastElementChild);
        last_row.removeChild(last_row.lastElementChild);
      }

      const row = document.createElement('div');
      row.classList.add('row');
      for (let i = 0; i < inputColumnCount; i++) {
        const input = document.createElement('input');
        input.type = 'number';
        input.step = 'any';
        row.appendChild(input);
      }

      if (last) {
        const add_button = document.createElement('button');
        add_button.textContent = "+";
        add_button.onclick = addInputColumn;
        const delete_button = document.createElement('button');
        delete_button.textContent = "-";
        delete_button.onclick = removeInputColumn;
        row.appendChild(add_button);
        row.appendChild(delete_button);
      } 

      container.appendChild(row);
    }

    function removeInputRow() {
      const container = document.getElementById('input-data-container');
      const rows = document.querySelectorAll('#input-data-container .row');
      if (rows.length <= 1) return;

      container.removeChild(container.lastElementChild);

      last_row = container.lastElementChild;
      const [add_button, delete_button] = createColumnButtons(addInputColumn, removeInputColumn);
      last_row.appendChild(add_button);
      last_row.appendChild(delete_button);
    }


    function addInputColumn() {
      const rows = document.querySelectorAll('#input-data-container .row');
      rows.forEach((row, index) => {
        const input = document.createElement('input');
        input.type = 'number';
        input.step = 'any';

        if (index == rows.length - 1) {
          row.removeChild(row.lastElementChild);
          row.removeChild(row.lastElementChild);
          row.appendChild(input);
          updateInputHeaders(row.children.length);

          const [add_button, delete_button] = createColumnButtons(addInputColumn, removeInputColumn);
          row.appendChild(add_button);
          row.appendChild(delete_button);
        }
        else row.appendChild(input);
      });
    }

    function removeInputColumn() {
      const rows = document.querySelectorAll('#input-data-container .row');
      if (rows.length <= 1 && rows[0].children.length <= 3 || rows[0].children.length <= 2) return;
      rows.forEach((row, index) => {
        if (index == rows.length - 1) {
          row.removeChild(row.lastElementChild);
          row.removeChild(row.lastElementChild);
          row.removeChild(row.lastElementChild);
          updateInputHeaders(row.children.length);
          const [add_button, delete_button] = createColumnButtons(addInputColumn, removeInputColumn);
          row.appendChild(add_button);
          row.appendChild(delete_button);
        }
        else row.removeChild(row.lastElementChild);
      });
    }


    function addCoefficient(last = false) {
      const row = document.getElementById('coefficients-row');
      const input = document.createElement('input');
      input.type = 'number';
      input.step = 'any';

      if (last) {
        row.removeChild(row.lastElementChild);
        row.removeChild(row.lastElementChild);
        row.appendChild(input);
        const [add_button, delete_button] = createColumnButtons(addCoefficient, removeCoefficient);
        row.appendChild(add_button);
        row.appendChild(delete_button);
      }
      else row.appendChild(input);

    }
    function removeCoefficient() {
      const row = document.getElementById('coefficients-row');
      if (row.children.length-2 <= 1) return;

      row.removeChild(row.lastElementChild);
      row.removeChild(row.lastElementChild);
      row.removeChild(row.lastElementChild);

      const [add_button, delete_button] = createColumnButtons(addCoefficient, removeCoefficient);
      row.appendChild(add_button);
      row.appendChild(delete_button);
    }

    function toggleBlocks() {
      const predictChecked = document.getElementById('predict_result').checked;
      document.getElementById('coefficients-block').classList.toggle('hidden', !predictChecked);
      document.getElementById('result-block').classList.toggle('hidden', !predictChecked);
    }

    function resetConstants() {
      document.getElementById('g_standart').value = 0.33;
      document.getElementById('f_standart').value = 3.63;
      document.getElementById('t_test').value = 5.841;
      document.getElementById('coef_accuracy').value = 6;
      document.getElementById('result_accuracy').value = 2;
      document.getElementById('optimize_coef').checked = true;
    }

    // Стартовые данные
    window.onload = () => {
      const last = false;
      for (let i = 0; i < inputRowCount; i++) {
        if (i == inputRowCount-1 || i == 0) addInputRow(true);
        else addInputRow(false);
      }
      for (let i = 0; i < inputColumnCount; i++) {
        if (i == inputColumnCount - 1) addCoefficient(true);
        else addCoefficient();
      }
      toggleBlocks();
      updateInputHeaders(inputColumnCount);
    };


    async function submitData() {
      // 1. Mods
      const calcCoef = document.getElementById('calc_coef').checked;
      const predictResult = document.getElementById('predict_result').checked;

      // 2. InputData
      const inputData = [];
      document.querySelectorAll('#input-data-container .row').forEach(row => {
        const rowData = Array.from(row.querySelectorAll('input')).map(input => parseFloat(input.value));
        inputData.push(rowData);
      });

      // 3. Coefs
      const coefRow = document.getElementById('coefficients-row');
      const coefInputs = Array.from(coefRow.querySelectorAll('input'));
      const coefficients = coefInputs.map(input => parseFloat(input.value));

      // 4. Constns
      const constants = {
        g_standart: parseFloat(document.getElementById('g_standart').value),
        f_standart: parseFloat(document.getElementById('f_standart').value),
        t_test: parseFloat(document.getElementById('t_test').value),
        coef_accuracy: parseInt(document.getElementById('coef_accuracy').value),
        result_accuracy: parseInt(document.getElementById('result_accuracy').value),
        optimize_coef: document.getElementById('optimize_coef').checked
      };

      const payload = {
        mode: {
          calc_coef: calcCoef,
          predict_result: predictResult
        },
        input_data: inputData,
        coefficients: coefficients,
        constants: constants
      };

      try {
        const response = await fetch("http://127.0.0.1:8000/analyze", {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify(payload)
        });

        if (!response.ok) throw new Error("Network error");

        const result = await response.json();
        alert("Ответ от сервера: " + JSON.stringify(result)); // или отобразить красиво
      } catch (error) {
        console.error("Ошибка при отправке:", error);
        alert("Не удалось отправить данные на сервер.");
      } 
    }

    function handleCSVUpload(event) {
      const file = event.target.files[0];
      if (!file || !file.name.endsWith(".csv")) {
        alert("Пожалуйста, выберите CSV-файл.");
        return;
      }

      const reader = new FileReader();
      reader.onload = function (e) {
        const text = e.target.result;
        const rows = text.trim().split("\n").map(row => row.split(";").map(Number));

        inputColumnCount = Math.max(...rows.map(r => r.length));
        inputRowCount = rows.length;

        const container = document.getElementById('input-data-container');
        container.innerHTML = "";

        rows.forEach((values, rowIndex) => {
          const row = document.createElement('div');
          row.classList.add('row');

          for (let i = 0; i < inputColumnCount; i++) {
            const input = document.createElement('input');
            input.type = 'number';
            input.step = 'any';
            input.value = values[i] ?? "";
            row.appendChild(input);
          }

          if (rowIndex === rows.length - 1) {
            updateInputHeaders(row.children.length);
            const [add_button, delete_button] = createColumnButtons(addInputColumn, removeInputColumn);
            row.appendChild(add_button);
            row.appendChild(delete_button);
          }

          container.appendChild(row);
        });
      };

      reader.readAsText(file);
    }
  </script>
</body>
</html>